# -*- mode: ruby -*-

CPP_COMPILER = "g++"
GTEST_DIR = "gtest-1.7.0"


task :all => ["clean", "run"]
task :default => "run"

task :run => "sample" do
  puts "---- run ----"
  sh "./sample"
end

task :clean do
  puts "---- clean ----"
  sh "rm -f ./*.o ./*.a"
  sh "rm -f sample"
end

file "gtest_build" do
  puts "--- build gtest ----"
  sh "mkdir gtest_build"
  Dir.chdir("gtest_build") do
    sh "cmake ../#{GTEST_DIR}"
    sh "make gtest gtest_main"
  end
end

file "libgtest.a" => "gtest_build" do
  sh "cp ./gtest_build/libgtest.a ./"
end

file "libgtest_main.a" => "gtest_build" do
  sh "cp ./gtest_build/libgtest_main.a ./"
end

rule ".o" => ".cc" do |t|
  sh "#{CPP_COMPILER} -I#{GTEST_DIR}/include -c #{t.source} -o #{t.name}"
end

file "sample" => ["sample.o", "libgtest.a", "libgtest_main.a"] do |t|
  sh "#{CPP_COMPILER} -pthread -o #{t.name} #{t.prerequisites.join(' ')}"
end
